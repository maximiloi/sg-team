name: Next.js Deploy to VDS

on:
  push:
    branches: [main]
  workflow_dispatch:  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout
    - uses: actions/checkout@v4

    # 2. Node.js + Cache
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    # 3. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ (Ð±Ñ‹ÑÑ‚Ñ€Ð¾ Ñ ÐºÑÑˆÐµÐ¼)
    - run: npm ci --frozen-lockfile

    # 4. Build (Ñ env Ð´Ð»Ñ API routes)
    - name: Build
      run: npm run build
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_MANAGER_IDS: ${{ secrets.TELEGRAM_MANAGER_IDS }}
        NEXT_TELEMETRY_DISABLED: 1

    # 5. Prepare deploy (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½ÑƒÐ¶Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹)
    - name: Prepare deploy
      run: |
        mkdir -p deploy
        rsync -av --exclude='*.git' .next/ deploy/
        rsync -av public/ deploy/ || true
        rsync -av prisma/ deploy/
        rsync -av bot/ deploy/ || true
        cp package*.json ecosystem.config.cjs deploy/
        cp next.config.js deploy/ || true
        cp .env.example deploy/.env.example || true
        tar -czf deploy.tar.gz -C deploy .

    # 6. SSH setup
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

    - name: Add known_hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    # 7. Upload archive (Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ scp)
    - name: Upload deploy archive
      run: scp deploy.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/

    # 8. Deploy Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ (Ð¾Ð´Ð½Ð¸Ð¼ SSH)
    - name: Deploy & Restart
      uses: appleboy/ssh-action@v1.2.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script_timeout: 10m
        script: |
          cd /var/www/sgt
          
          # Backup ÑÑ‚Ð°Ñ€Ð¾Ð³Ð¾ Ð±Ð¸Ð»Ð´Ð°
          [ -d "backup" ] || mkdir backup
          mv .next backup/.next.$(date +%Y%m%d_%H%M) 2>/dev/null || true
          
          # Ð Ð°Ð·Ð°Ñ€Ñ…Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹
          tar -xzf /tmp/deploy.tar.gz
          rm /tmp/deploy.tar.gz
          
          # Env Ñ„Ð°Ð¹Ð»
          cat > .env << EOF
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_MANAGER_IDS=${{ secrets.TELEGRAM_MANAGER_IDS }}
          NODE_ENV=production
          EOF
          
          # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° (ÑƒÐ¼Ð½Ð¾, Ð±ÐµÐ· Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ð¿ÐµÑ€ÐµÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸)
          if [ ! -d "node_modules/.prisma/client" ]; then
            npm ci --omit=dev --prefer-offline --no-audit || npm install --production
          fi
          
          # Prisma
          npx prisma generate
          npx prisma db push  # Ð‘Ñ‹ÑÑ‚Ñ€ÐµÐµ migrate Ð´Ð»Ñ dev/prod
          
          # PM2 restart
          pm2 reload ecosystem.config.cjs --update-env || pm2 start ecosystem.config.cjs --env production
          pm2 save
          
          echo "âœ… Deploy completed!"
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_MANAGER_IDS: ${{ secrets.TELEGRAM_MANAGER_IDS }}

    # 9. Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
    - name: Notify Telegram
      if: always()
      uses: appleboy/telegram-action@v0.1.5
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ðŸš€ ${{ github.repository }} deploy ${{ job.status }}
          Commit: ${{ github.sha }}
          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
