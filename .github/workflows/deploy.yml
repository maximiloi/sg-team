name: Next.js Deploy to VDS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - uses: actions/checkout@v4

      # 2. Node.js + ÐºÑÑˆ (Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹)
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3. Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
      - run: npm ci --frozen-lockfile

      # 4. Build (Ñ„Ð¸ÐºÑ Ð´Ð»Ñ /api/clients)
      - name: Build
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_MANAGER_IDS: ${{ secrets.TELEGRAM_MANAGER_IDS }}
          NEXT_TELEMETRY_DISABLED: 1

      # 5. ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ð´ÐµÐ¿Ð»Ð¾Ñ (Ð±Ñ‹ÑÑ‚Ñ€Ð¾ Ñ‡ÐµÑ€ÐµÐ· tar)
      - name: Prepare deploy
        run: |
          mkdir -p deploy
          rsync -av --exclude='*.git' .next/ deploy/ || true
          cp -r public prisma bot package*.json ecosystem.config.cjs deploy/ || true
          cp next.config.js deploy/ || true
          tar -czf deploy.tar.gz -C deploy .

      # 6. SSH Ð°Ð³ÐµÐ½Ñ‚
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      # 7. Known hosts
      - name: Setup known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # 8. Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ñ€Ñ…Ð¸Ð²Ð°
      - name: Upload deploy archive
        run: |
          scp deploy.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/

      # 9. Ð”ÐµÐ¿Ð»Ð¾Ð¹
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.2.0
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_MANAGER_IDS: ${{ secrets.TELEGRAM_MANAGER_IDS }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          command_timeout: 20m
          script: |
            set -e
            cd /var/www/sgt || mkdir -p /var/www/sgt && cd /var/www/sgt

            echo "ðŸ“¦ Backup ÑÑ‚Ð°Ñ€Ð¾Ð³Ð¾ Ð±Ð¸Ð»Ð´Ð°..."
            mkdir -p backup
            mv .next backup/.next.$(date +%Y%m%d_%H%M) 2>/dev/null || true

            echo "ðŸ“¦ Ð Ð°Ð·Ð°Ñ€Ñ…Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ð±Ð¸Ð»Ð´..."
            tar -xzf /tmp/deploy.tar.gz -C .
            rm -f /tmp/deploy.tar.gz

            echo "ðŸ”§ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ .env..."
            cat > .env << EOF
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            TELEGRAM_MANAGER_IDS=${{ secrets.TELEGRAM_MANAGER_IDS }}
            NODE_ENV=production
            EOF

            echo "âš™ï¸ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Prisma..."
            if [ ! -d "node_modules/.prisma/client" ]; then
              echo "ðŸ”„ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ (Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº)..."
              npm install --production --no-audit --no-fund
            else
              echo "âœ… node_modules Ð°ÐºÑ‚ÑƒÐ°Ð»ÐµÐ½, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ npm install"
            fi

            echo "ðŸ—„ï¸ Prisma generate & migrate..."
            npx prisma generate --schema=prisma/schema.prisma
            npx prisma db push --schema=prisma/schema.prisma || npx prisma migrate deploy

            echo "ðŸ”„ PM2 reload..."
            pm2 reload ecosystem.config.cjs --update-env || pm2 start ecosystem.config.cjs --env production
            pm2 save

            echo "âœ… Deploy Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½ Ð·Ð° $(date +%s) ÑÐµÐº"
