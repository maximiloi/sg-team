name: Next.js Deploy to VDS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - uses: actions/checkout@v4

      # 2. Node.js + –∫—ç—à (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π)
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - run: npm ci --frozen-lockfile

      # 4. Build (—Ñ–∏–∫—Å –¥–ª—è /api/clients)
      - name: Build
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_MANAGER_IDS: ${{ secrets.TELEGRAM_MANAGER_IDS }}
          NEXT_TELEMETRY_DISABLED: 1

      # 5. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–µ–ø–ª–æ—è (–±—ã—Å—Ç—Ä–æ —á–µ—Ä–µ–∑ tar)
      - name: Prepare deploy
        run: |
          mkdir -p deploy
          cp -r .next deploy/
          mkdir -p deploy/public
          cp -r public/* deploy/public/ 2>/dev/null || true
          cp -r prisma deploy/
          cp -r src deploy/
          cp package*.json ecosystem.config.cjs deploy/
          ls -la deploy/.next/
          tar -czf deploy.tar.gz -C deploy .

      # 6. SSH –∞–≥–µ–Ω—Ç
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      # 7. Known hosts
      - name: Setup known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # 8. –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ö–∏–≤–∞
      - name: Upload deploy archive
        run: |
          scp deploy.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/

      # 9. –î–µ–ø–ª–æ–π
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.2.0
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_MANAGER_IDS: ${{ secrets.TELEGRAM_MANAGER_IDS }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          command_timeout: 20m
          script: |
            set -e
            cd /var/www/sgt || mkdir -p /var/www/sgt && cd /var/www/sgt

            echo "üì¶ Backup —Å—Ç–∞—Ä–æ–≥–æ –±–∏–ª–¥–∞..."
            mkdir -p backup
            mv .next backup/.next.$(date +%Y%m%d_%H%M) 2>/dev/null || true

            echo "üì¶ –†–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –±–∏–ª–¥..."
            tar -xzf /tmp/deploy.tar.gz -C .
            rm -f /tmp/deploy.tar.gz

            echo "üîß –û–±–Ω–æ–≤–ª—è–µ–º .env..."
            cat > .env << EOF
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            TELEGRAM_MANAGER_IDS=${{ secrets.TELEGRAM_MANAGER_IDS }}
            NODE_ENV=production
            EOF

            echo "‚öôÔ∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º Prisma..."
            if [ ! -d "node_modules/.prisma/client" ]; then
              echo "üîÑ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫)..."
              npm install --production --no-audit --no-fund
            else
              echo "‚úÖ node_modules –∞–∫—Ç—É–∞–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º npm install"
            fi

            # echo "üßπ –û–ß–ò–°–¢–ö–ê –ú–£–°–û–†–ê..."
            # find . -maxdepth 1 \( -name "build*" -o -name "cache*" -o -name "trace*" -o -name "*-manifest.json" -o -name "diagnostics*" -o -name "turbopack*" \) -exec rm -rf {} + 2>/dev/null || true

            # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ (–æ—Å—Ç–∞–≤–∏—Ç—å 3 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö)
            #ls -t backup/.next.* 2>/dev/null | tail -n +4 | xargs -r rm -rf

            echo "üì¶ –î–æ: $(du -sh .)"

            echo "üóÑÔ∏è –¢–æ–ª—å–∫–æ Prisma generate..."
            npx prisma generate --schema=prisma/schema.prisma

            echo "üóÑÔ∏è –ü–†–ò–ú–ï–ù–Ø–ï–ú –ú–ò–ì–†–ê–¶–ò–ò –ë–î..."
            npx prisma migrate deploy

            echo "üîÑ PM2 reload..."
            pm2 reload ecosystem.config.cjs --update-env || pm2 start ecosystem.config.cjs --env production
            pm2 save

            echo "üìä –ê—É–¥–∏—Ç –º–µ—Å—Ç–∞:" && du -sh .[^.]* * 2>/dev/null | sort -hr | head -10

            echo "‚úÖ Deploy –∑–∞–≤–µ—Ä—à—ë–Ω –∑–∞ $(date +%s) —Å–µ–∫"
